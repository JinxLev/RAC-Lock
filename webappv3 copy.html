<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAC Firebase Control Panel v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">RAC Firebase Control Panel v2</h1>
        <p class="text-sm text-gray-600">Single‑file web app to control ESP32 smart lock, manage RFID users, and filter/export events (using Firebase RTDB REST + streaming).</p>
      </div>
      <span id="connStatus" class="text-sm text-red-700">Disconnected</span>
    </header>

    <!-- Tabs -->
    <div class="mb-4 flex gap-2">
      <button data-tab="tab-conn" class="tab-btn rounded-xl px-3 py-2 bg-slate-800 text-white">Connection</button>
      <button data-tab="tab-control" class="tab-btn rounded-xl px-3 py-2 bg-white border">Control</button>
      <button data-tab="tab-users" class="tab-btn rounded-xl px-3 py-2 bg-white border">Users</button>
      <button data-tab="tab-events" class="tab-btn rounded-xl px-3 py-2 bg-white border">Events</button>
      <button data-tab="tab-config" class="tab-btn rounded-xl px-3 py-2 bg-white border">Config</button>
    </div>

    <!-- Connection -->
    <section id="tab-conn" class="tab-pane bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-xl font-semibold mb-4">Connection</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <label class="block">
          <span class="text-sm font-medium">Database URL (no trailing slash)</span>
          <input id="dbUrl" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="https://<project>.asia-southeast1.firebasedatabase.app" />
        </label>
        <label class="block">
          <span class="text-sm font-medium">Legacy DB Secret (testing only)</span>
          <input id="dbAuth" type="password" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="<secret>" />
        </label>
        <div class="flex items-end gap-2">
          <button id="connectBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white font-semibold hover:bg-blue-700">Connect</button>
          <button id="disconnectBtn" class="rounded-xl px-4 py-2 bg-slate-200">Disconnect</button>
        </div>
      </div>
      <p class="mt-2 text-xs text-amber-700">Security note: don’t deploy this with a real secret; for production use Firebase Web SDK and secure rules/auth.</p>
    </section>

    <!-- Control & State -->
    <section id="tab-control" class="tab-pane hidden">
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-2xl shadow p-4 md:p-6">
          <h2 class="text-xl font-semibold mb-4">Servo</h2>
          <div class="flex items-center gap-3 mb-3">
            <input id="servoRange" type="range" min="0" max="180" value="70" class="w-full"/>
            <input id="servoValue" type="number" min="0" max="180" value="70" class="w-20 rounded-xl border px-2 py-1"/>
          </div>
          <div class="flex gap-2">
            <button id="servoSend" class="rounded-xl px-4 py-2 bg-green-600 text-white font-semibold hover:bg-green-700">Send /servo</button>
            <button id="servoOpen" class="rounded-xl px-4 py-2 bg-slate-700 text-white">Open (unlock)</button>
            <button id="servoClose" class="rounded-xl px-4 py-2 bg-slate-700 text-white">Close (lock)</button>
          </div>
          <p class="text-xs text-gray-600 mt-2">Writes to <code>/servo</code> (compat). Device mirrors to <code>/state/servo_angle</code>.</p>
        </div>
        <div class="bg-white rounded-2xl shadow p-4 md:p-6">
          <h2 class="text-xl font-semibold mb-4">Live State</h2>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><div class="text-gray-500">Mode</div><div id="stateMode" class="font-mono">—</div></div>
            <div><div class="text-gray-500">Servo Angle</div><div id="stateServo" class="font-mono">—</div></div>
            <div><div class="text-gray-500">IP</div><div id="stateIp" class="font-mono">—</div></div>
            <div><div class="text-gray-500">RSSI</div><div id="stateRssi" class="font-mono">—</div></div>
            <div><div class="text-gray-500">Needs Reboot</div><div id="stateReboot" class="font-mono">—</div></div>
            <div><div class="text-gray-500">Uptime (ms)</div><div id="stateUptime" class="font-mono">—</div></div>
            <div><div class="text-gray-500">Last UID</div><div id="stateUID" class="font-mono">—</div></div>
            <div><div class="text-gray-500">Last User</div><div id="stateUser" class="font-mono">—</div></div>
          </div>
          <p class="text-xs text-gray-600 mt-2">Streaming <code>/state</code> via REST <code>EventSource</code>.</p>
        </div>
      </div>
    </section>

    <!-- Users Management -->
    <section id="tab-users" class="tab-pane hidden bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-xl font-semibold mb-4">RFID Users</h2>
      <div class="grid md:grid-cols-3 gap-3 mb-4">
        <label class="block"><span class="text-sm font-medium">UID (hex)</span><input id="u_uid" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="04AB1234"/></label>
        <label class="block"><span class="text-sm font-medium">Name</span><input id="u_name" class="mt-1 w-full rounded-xl border px-3 py-2" placeholder="Alice"/></label>
        <div class="flex items-end gap-2">
          <button id="u_add" class="rounded-xl px-4 py-2 bg-blue-600 text-white font-semibold hover:bg-blue-700">Add / Update</button>
          <button id="u_refresh" class="rounded-xl px-4 py-2 bg-slate-200">Refresh</button>
        </div>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="text-left p-2">UID</th>
              <th class="text-left p-2">Name</th>
              <th class="text-left p-2">Enabled</th>
              <th class="text-left p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="usersBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Events -->
    <section id="tab-events" class="tab-pane hidden bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 class="text-xl font-semibold mb-4">Events</h2>
      <div class="grid md:grid-cols-5 gap-3 mb-3 text-sm">
        <label>Type
          <select id="ev_type" class="w-full border rounded px-2 py-1">
            <option value="">All</option>
            <option>UNLOCK</option>
            <option>LOCK</option>
            <option>RFID_DENY</option>
            <option>REMOTE</option>
            <option>BOOT</option>
            <option>ERROR</option>
          </select>
        </label>
        <label>From
          <input id="ev_from" type="datetime-local" class="w-full border rounded px-2 py-1" />
        </label>
        <label>To
          <input id="ev_to" type="datetime-local" class="w-full border rounded px-2 py-1" />
        </label>
        <label>User contains
          <input id="ev_user" class="w-full border rounded px-2 py-1" placeholder="userId or name" />
        </label>
        <label>UID contains
          <input id="ev_uid" class="w-full border rounded px-2 py-1" placeholder="04AB" />
        </label>
      </div>
      <div class="flex gap-2 mb-3">
        <button id="ev_refresh" class="rounded-xl px-4 py-2 bg-slate-800 text-white">Refresh (last 500)</button>
        <button id="ev_export" class="rounded-xl px-4 py-2 bg-green-600 text-white">Export CSV (filtered)</button>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="text-left p-2">ts</th>
              <th class="text-left p-2">type</th>
              <th class="text-left p-2">by</th>
              <th class="text-left p-2">uid</th>
              <th class="text-left p-2">user</th>
              <th class="text-left p-2">reason</th>
              <th class="text-left p-2">duration_ms</th>
              <th class="text-left p-2">key</th>
            </tr>
          </thead>
          <tbody id="eventsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Config -->
    <section id="tab-config" class="tab-pane hidden">
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-2xl shadow p-4 md:p-6">
          <h2 class="text-xl font-semibold mb-4">Config: Servo</h2>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <label>Pin <input id="cfg_servo_pin" type="number" class="w-full border rounded px-2 py-1" value="22"/></label>
            <label>Unlock <input id="cfg_servo_unlock" type="number" class="w-full border rounded px-2 py-1" value="0"/></label>
            <label>Lock <input id="cfg_servo_lock" type="number" class="w-full border rounded px-2 py-1" value="90"/></label>
            <label>Min µs <input id="cfg_servo_min" type="number" class="w-full border rounded px-2 py-1" value="500"/></label>
            <label>Max µs <input id="cfg_servo_max" type="number" class="w-full border rounded px-2 py-1" value="2400"/></label>
          </div>
          <button id="saveServoCfg" class="mt-3 rounded-xl px-4 py-2 bg-blue-600 text-white font-semibold hover:bg-blue-700">Save</button>
        </div>
        <div class="bg-white rounded-2xl shadow p-4 md:p-6">
          <h2 class="text-xl font-semibold mb-4">Config: Lock & LCD</h2>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <label>Auto‑lock (ms) <input id="cfg_auto_lock" type="number" class="w-full border rounded px-2 py-1" value="8000"/></label>
            <label>RFID Enable <select id="cfg_rfid_enable" class="w-full border rounded px-2 py-1"><option value="true">true</option><option value="false">false</option></select></label>
            <label>Remote Enable <select id="cfg_remote_enable" class="w-full border rounded px-2 py-1"><option value="true">true</option><option value="false">false</option></select></label>
            <label>Poll (ms) <input id="cfg_poll" type="number" class="w-full border rounded px-2 py-1" value="250"/></label>
            <label>Servo timeout (ms) <input id="cfg_servo_to" type="number" class="w-full border rounded px-2 py-1" value="2000"/></label>
            <label>LCD Enable <select id="cfg_lcd_enable" class="w-full border rounded px-2 py-1"><option value="true">true</option><option value="false">false</option></select></label>
            <label>I2C SDA <input id="cfg_lcd_sda" type="number" class="w-full border rounded px-2 py-1" value="27"/></label>
            <label>I2C SCL <input id="cfg_lcd_scl" type="number" class="w-full border rounded px-2 py-1" value="26"/></label>
            <label>LCD Addr (hex) <input id="cfg_lcd_addr" type="text" class="w-full border rounded px-2 py-1" value="0x27"/></label>
            <label>Cols × Rows
              <div class="flex gap-2">
                <input id="cfg_lcd_cols" type="number" class="w-full border rounded px-2 py-1" value="16"/>
                <input id="cfg_lcd_rows" type="number" class="w-full border rounded px-2 py-1" value="2"/>
              </div>
            </label>
          </div>
          <button id="saveLockLcdCfg" class="mt-3 rounded-xl px-4 py-2 bg-blue-600 text-white font-semibold hover:bg-blue-700">Save</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------------- Core RTDB REST helpers ----------------
    let DB_URL = '', AUTH = '';
    let esState = null, esServo = null;

    const $ = (id) => document.getElementById(id);
    const pad = (n) => n < 10 ? '0'+n : n;

    function setStatus(msg, ok=true){
      const el = $('connStatus');
      el.textContent = msg;
      el.className = ok ? 'text-sm text-green-700' : 'text-sm text-red-700';
    }
    function pathUrl(path, qp=''){
      const clean = path.startsWith('/')? path : '/'+path;
      const base = DB_URL.replace(/\/$/, '') + clean + '.json?auth=' + encodeURIComponent(AUTH);
      return qp ? base + '&' + qp : base;
    }
    async function dbGet(path, qp=''){
      const r = await fetch(pathUrl(path, qp));
      if(!r.ok) throw new Error('GET '+path+' -> '+r.status);
      return r.json();
    }
    async function dbPut(path, value){
      const r = await fetch(pathUrl(path), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(value) });
      if(!r.ok) throw new Error('PUT '+path+' -> '+r.status);
      return r.json();
    }
    async function dbPatch(path, value){
      const r = await fetch(pathUrl(path), { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(value) });
      if(!r.ok) throw new Error('PATCH '+path+' -> '+r.status);
      return r.json();
    }
    async function dbDelete(path){
      const r = await fetch(pathUrl(path), { method:'DELETE' });
      if(!r.ok) throw new Error('DELETE '+path+' -> '+r.status);
      return r.json();
    }

    // ---------------- Tabs ----------------
    function showTab(id){
      document.querySelectorAll('.tab-pane').forEach(e=>e.classList.add('hidden'));
      $(id).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.replace('bg-slate-800','bg-white'));
      document.querySelector(`[data-tab="${id}"]`).classList.replace('bg-white','bg-slate-800');
      document.querySelector(`[data-tab="${id}"]`).classList.add('text-white');
      document.querySelectorAll('.tab-btn').forEach(b=>{ if(b.getAttribute('data-tab')!==id) b.classList.remove('text-white'); });
      if (id === 'tab-events') {
        eventsRefresh();
      }
    }
    document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click', ()=>showTab(b.getAttribute('data-tab'))));
    showTab('tab-conn');

    // ---------------- Servo + State ----------------
    function bindServoUI(){
      const r = $('servoRange');
      const v = $('servoValue');
      if(!r || !v) return;
      r.addEventListener('input', ()=> v.value = r.value);
      v.addEventListener('input', ()=>{ const n = Math.max(0, Math.min(180, parseInt(v.value||0,10))); v.value=n; r.value=n; });
      $('servoSend').addEventListener('click', async ()=>{ try{ await dbPut('/servo', parseInt(v.value,10)); }catch(e){ alert(e.message); } });
      $('servoOpen').addEventListener('click', async ()=>{
  const target = parseInt($('cfg_servo_unlock').value || '0', 10);
  // Update UI immediately
  $('servoRange').value = target;
  $('servoValue').value = target;
  try{
    await dbPut('/servo', target);
  } catch(e){
    alert(e.message);
  }
});

$('servoClose').addEventListener('click', async ()=>{
  const target = parseInt($('cfg_servo_lock').value || '90', 10);
  // Update UI immediately
  $('servoRange').value = target;
  $('servoValue').value = target;
  try{
    await dbPut('/servo', target);
  } catch(e){
    alert(e.message);
  }
});
    }

    function updateStateUI(st){
      $('stateMode').textContent   = st.mode ?? '—';
      $('stateServo').textContent  = st.servo_angle ?? '—';
      $('servoRange') && ($('servoRange').value = st.servo_angle ?? $('servoRange').value);
      $('servoValue') && ($('servoValue').value = st.servo_angle ?? $('servoValue').value);
      $('stateIp').textContent     = st.ip ?? '—';
      $('stateRssi').textContent   = st.rssi ?? '—';
      $('stateReboot').textContent = st.needs_reboot === true ? 'true' : 'false';
      $('stateUptime').textContent = st.uptime_ms ?? '—';
      $('stateUID').textContent    = st.last_uid ?? '—';
      $('stateUser').textContent   = st.last_user ?? '—';
    }

    function startStreams(){
      if(esState){ esState.close(); esState=null; }
      if(esServo){ esServo.close(); esServo=null; }
      esState = new EventSource(pathUrl('/state'));
      esState.onmessage = ev => { if(!ev.data) return; try{ updateStateUI(JSON.parse(ev.data)); }catch{} };
      esState.onerror = ()=> setStatus('State stream error (retrying...)', false);
      esServo = new EventSource(pathUrl('/servo'));
      esServo.onmessage = ev => { if(!ev.data) return; try{ const a = JSON.parse(ev.data); if(typeof a==='number'){ $('servoRange').value=a; $('servoValue').value=a; } }catch{} };
      esServo.onerror = ()=> setStatus('Servo stream error (retrying...)', false);
    }

    async function loadInitial(){
      try{
        const st = await dbGet('/state'); updateStateUI(st||{});
        const cfg = await dbGet('/config');
        if(cfg){
          const s = cfg.servo||{}; $('cfg_servo_pin').value = s.pin ?? 22; $('cfg_servo_unlock').value = s.unlock_angle ?? 0; $('cfg_servo_lock').value = s.lock_angle ?? 90; $('cfg_servo_min').value = s.min_us ?? 500; $('cfg_servo_max').value = s.max_us ?? 2400;
          const l = cfg.lock||{}; $('cfg_auto_lock').value = l.auto_lock_ms ?? 8000; $('cfg_rfid_enable').value = String(l.rfid_enable ?? true); $('cfg_remote_enable').value = String(l.remote_enable ?? true);
          const a = cfg.app||{}; $('cfg_poll').value = a.poll_ms ?? 250; $('cfg_servo_to').value = a.servo_timeout_ms ?? 2000;
          const lcd = cfg.lcd||{}; $('cfg_lcd_enable').value = String(lcd.enable ?? true); $('cfg_lcd_sda').value = lcd.sda ?? 27; $('cfg_lcd_scl').value = lcd.scl ?? 26; $('cfg_lcd_addr').value = '0x'+((lcd.address ?? 0x27).toString(16)); $('cfg_lcd_cols').value = lcd.cols ?? 16; $('cfg_lcd_rows').value = lcd.rows ?? 2;
        }
        startStreams();
        await usersRefresh();
        setStatus('Connected');
      }catch(e){ setStatus('Failed: '+e.message, false); }
    }

    // ---------------- Users ----------------
    let USERS = {};
    function normalizeUser(uid, val){
      let name = '', enabled = true;
      if(typeof val === 'string'){ name = val; enabled = true; }
      else if(val && typeof val === 'object'){ name = val.name || ''; enabled = (val.enabled !== false); }
      return { uid: uid, name, enabled, raw: val };
    }
    function renderUsers(){
      const body = $('usersBody'); body.innerHTML = '';
      const entries = Object.entries(USERS).map(([k,v])=>normalizeUser(k,v)).sort((a,b)=>a.uid.localeCompare(b.uid));
      for(const u of entries){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 font-mono text-xs">${u.uid}</td>
          <td class="p-2">
            <span class="u-name">${u.name}</span>
            <input class="u-name-edit hidden w-48 border rounded px-1 py-0.5" value="${u.name}">
          </td>
          <td class="p-2">${u.enabled?'<span class="px-2 py-0.5 text-xs rounded bg-green-100 text-green-700">true</span>':'<span class="px-2 py-0.5 text-xs rounded bg-red-100 text-red-700">false</span>'}</td>
          <td class="p-2 flex gap-2">
            <button class="btn-edit rounded px-2 py-1 border">Edit</button>
            <button class="btn-toggle rounded px-2 py-1 border">${u.enabled?'Disable':'Enable'}</button>
            <button class="btn-del rounded px-2 py-1 border text-red-700">Delete</button>
            <button class="btn-save hidden rounded px-2 py-1 bg-blue-600 text-white">Save</button>
            <button class="btn-cancel hidden rounded px-2 py-1 border">Cancel</button>
          </td>`;
        // handlers
        const nameSpan = tr.querySelector('.u-name');
        const nameEdit = tr.querySelector('.u-name-edit');
        const btnEdit = tr.querySelector('.btn-edit');
        const btnSave = tr.querySelector('.btn-save');
        const btnCancel = tr.querySelector('.btn-cancel');
        const btnToggle = tr.querySelector('.btn-toggle');
        const btnDel = tr.querySelector('.btn-del');
        btnEdit.addEventListener('click', ()=>{ nameSpan.classList.add('hidden'); nameEdit.classList.remove('hidden'); btnEdit.classList.add('hidden'); btnSave.classList.remove('hidden'); btnCancel.classList.remove('hidden'); nameEdit.focus(); });
        btnCancel.addEventListener('click', ()=>{ nameEdit.value = u.name; nameSpan.classList.remove('hidden'); nameEdit.classList.add('hidden'); btnEdit.classList.remove('hidden'); btnSave.classList.add('hidden'); btnCancel.classList.add('hidden'); });
        btnSave.addEventListener('click', async ()=>{ try{ await dbPut('/users/'+u.uid, { name: nameEdit.value.trim(), enabled: u.enabled }); USERS[u.uid] = { name: nameEdit.value.trim(), enabled: u.enabled }; renderUsers(); }catch(e){ alert(e.message); } });
        btnToggle.addEventListener('click', async ()=>{ try{ const next = !u.enabled; const name = (USERS[u.uid] && USERS[u.uid].name) || u.name; await dbPut('/users/'+u.uid, { name, enabled: next }); USERS[u.uid] = { name, enabled: next }; renderUsers(); }catch(e){ alert(e.message); } });
        btnDel.addEventListener('click', async ()=>{ if(!confirm('Delete UID '+u.uid+'?')) return; try{ await dbDelete('/users/'+u.uid); delete USERS[u.uid]; renderUsers(); }catch(e){ alert(e.message); } });
        $('usersBody').appendChild(tr);
      }
    }
    async function usersRefresh(){
      try{ USERS = (await dbGet('/users')) || {}; renderUsers(); }
      catch(e){ alert('Users error: '+e.message); }
    }

    $('u_add').addEventListener('click', async ()=>{
      const uid = ($('u_uid').value||'').trim().toUpperCase();
      const name = ($('u_name').value||'').trim();
      if(!uid || !name) return alert('Provide UID and Name');
      try{ await dbPut('/users/'+uid, { name, enabled: true }); USERS[uid] = { name, enabled: true }; renderUsers(); $('u_uid').value=''; $('u_name').value=''; }
      catch(e){ alert(e.message); }
    });
    $('u_refresh').addEventListener('click', usersRefresh);

    // ---------------- Events ----------------
    let EVENTS = []; // raw list
    function toISO(ts){ try{ const d = new Date(ts); const y=d.getFullYear(); const M=pad(d.getMonth()+1); const D=pad(d.getDate()); const h=pad(d.getHours()); const m=pad(d.getMinutes()); const s=pad(d.getSeconds()); return `${y}-${M}-${D} ${h}:${m}:${s}`;}catch{return String(ts);} }

    function applyEventFilters(){
      const type = $('ev_type').value;
      const from = $('ev_from').value ? new Date($('ev_from').value).getTime() : -Infinity;
      const to   = $('ev_to').value ? new Date($('ev_to').value).getTime()   :  Infinity;
      const userf = ($('ev_user').value||'').toLowerCase();
      const uidf  = ($('ev_uid').value||'').toLowerCase();
      const filtered = EVENTS.filter(e=>{
        if(type && e.type !== type) return false;
        if(typeof e.ts === 'number'){
          if(e.ts < from || e.ts > to) return false;
        }
        if(userf && !(`${e.by||''} ${e.user||''}`.toLowerCase().includes(userf))) return false;
        if(uidf && !(`${e.uid||''}`.toLowerCase().includes(uidf))) return false;
        return true;
      });
      renderEvents(filtered);
      return filtered;
    }

    function renderEvents(list){
      const body = $('eventsBody'); body.innerHTML = '';
      // newest first
      const rows = list.slice().sort((a,b)=> (b.ts||0) - (a.ts||0));
      for(const ev of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 font-mono text-xs">${toISO(ev.ts)}</td>
          <td class="p-2">${ev.type||''}</td>
          <td class="p-2">${ev.by||''}</td>
          <td class="p-2 font-mono text-xs">${ev.uid||''}</td>
          <td class="p-2">${ev.user||''}</td>
          <td class="p-2">${ev.reason||''}</td>
          <td class="p-2">${(ev.duration_ms ?? '')}</td>
          <td class="p-2 font-mono text-xs">${ev._key||''}</td>`;
        body.appendChild(tr);
      }
    }

    async function eventsRefresh(){
      try{
        const data = await dbGet('/events', 'orderBy="$key"&limitToLast=500');
        EVENTS = [];
        if(data){ for(const [k,v] of Object.entries(data)){ EVENTS.push({ _key:k, ...(v||{}) }); } }
        applyEventFilters();
      }catch(e){ alert('Events error: '+e.message); }
    }

    function downloadCSV(rows){
      const header = ['ts','iso','type','by','uid','user','reason','duration_ms','key'];
      const csv = [header.join(',')].concat(rows.map(e=>{
        const iso = toISO(e.ts||'');
        const vals = [e.ts||'', iso, e.type||'', e.by||'', e.uid||'', e.user||'', e.reason||'', e.duration_ms||'', e._key||''];
        return vals.map(v=>{
          const s = String(v).replace(/"/g,'""');
          return /[",\n]/.test(s) ? '"'+s+'"' : s;
        }).join(',');
      })).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'rac_events.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    $('ev_refresh').addEventListener('click', eventsRefresh);
    $('ev_export').addEventListener('click', ()=>{ const filtered = applyEventFilters(); downloadCSV(filtered); });
    ['ev_type','ev_from','ev_to','ev_user','ev_uid'].forEach(id=> $(id).addEventListener('input', applyEventFilters));

    // ---------------- Config save ----------------
    $('saveServoCfg')?.addEventListener('click', async ()=>{
      const p = parseInt($('cfg_servo_pin').value,10);
      const unlock = parseInt($('cfg_servo_unlock').value,10);
      const lock   = parseInt($('cfg_servo_lock').value,10);
      const minus  = parseInt($('cfg_servo_min').value,10);
      const maxus  = parseInt($('cfg_servo_max').value,10);
      try{ await dbPatch('/config/servo', { pin:p, unlock_angle:unlock, lock_angle:lock, min_us:minus, max_us:maxus }); setStatus('Saved servo config'); }
      catch(e){ alert(e.message); }
    });
    $('saveLockLcdCfg')?.addEventListener('click', async ()=>{
      const lock = { auto_lock_ms: parseInt($('cfg_auto_lock').value,10), rfid_enable: $('cfg_rfid_enable').value==='true', remote_enable: $('cfg_remote_enable').value==='true' };
      const app  = { poll_ms: parseInt($('cfg_poll').value,10), servo_timeout_ms: parseInt($('cfg_servo_to').value,10) };
      const lcd  = { enable: $('cfg_lcd_enable').value==='true', sda: parseInt($('cfg_lcd_sda').value,10), scl: parseInt($('cfg_lcd_scl').value,10), address: parseInt(($('cfg_lcd_addr').value||'0x27'),16), cols: parseInt($('cfg_lcd_cols').value,10), rows: parseInt($('cfg_lcd_rows').value,10) };
      try{ await dbPatch('/config/lock', lock); await dbPatch('/config/app', app); await dbPatch('/config/lcd', lcd); setStatus('Saved lock/LCD config'); }
      catch(e){ alert(e.message); }
    });

    // ---------------- Connect / Disconnect ----------------
    $('connectBtn').addEventListener('click', async ()=>{
      DB_URL = $('dbUrl').value.trim(); AUTH = $('dbAuth').value.trim();
      if(!DB_URL || !AUTH) return setStatus('Missing DB URL or secret', false);
      setStatus('Connecting…');
      try{ await loadInitial(); showTab('tab-control'); }
      catch(e){ setStatus('Error: '+e.message, false); }
    });
    $('disconnectBtn').addEventListener('click', ()=>{
      if(esState){ esState.close(); esState=null; }
      if(esServo){ esServo.close(); esServo=null; }
      setStatus('Disconnected', false);
      showTab('tab-conn');
    });

    // Init controls
    bindServoUI();
  </script>
</body>
</html> 